---
import { getRelativeLocaleUrl } from 'astro:i18n';
import { Icon } from 'astro-icon/components';
import { LOCALES, DEFAULT_LOCALE } from '~/utils/locales';
import { I18N } from 'astrowind:config';
import { getPathWithoutLocale } from '~/utils/i18n';

export interface Props {
  currentLocale?: string;
  showLabels?: boolean;
  class?: string;
}

const { currentLocale = Astro.currentLocale || 'en', showLabels = false, class: className = '' } = Astro.props;

const currentPathWithoutLocale = getPathWithoutLocale(Astro.url.pathname);

// Helper function to get locale display name directly from config
const getLocaleDisplayName = (localeCode: string): string => {
  return I18N.localeNames?.[localeCode] || localeCode.toUpperCase();
};
---

<div class={`relative inline-block ${className}`}>
  <button
    type="button"
    class="text-muted dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center"
    aria-label="Change language"
    aria-haspopup="true"
    aria-expanded="false"
    data-aw-toggle-locale
  >
    <Icon name="tabler:language" class="w-5 h-5" />
    {showLabels && <span class="ml-2 rtl:ml-0 rtl:mr-2">{currentLocale.toUpperCase()}</span>}
    <Icon name="tabler:chevron-down" class="w-3 h-3 ml-1 rtl:ml-0 rtl:mr-1" />
  </button>

  <div
    data-aw-locale-dropdown
    class="hidden absolute z-50 bg-white divide-y divide-gray-100 rounded-lg shadow w-44 dark:bg-gray-700"
    role="menu"
  >
    <ul class="py-2 text-sm text-gray-700 dark:text-gray-200">
      {
        LOCALES.map((locale: string) => {
          // Generate URL for this locale
          let url: string;
          try {
            // Try using getRelativeLocaleUrl with path without locale
            url = getRelativeLocaleUrl(locale, currentPathWithoutLocale);
            // Ensure no trailing slash to match trailingSlash: 'never' config
            if (url.endsWith('/') && url !== '/') {
              url = url.slice(0, -1);
            }
          } catch {
            // Fallback: manually construct URL
            const shouldPrefix = locale !== DEFAULT_LOCALE;
            const cleanPath = currentPathWithoutLocale === '/' ? '' : currentPathWithoutLocale;
            url = shouldPrefix ? `/${locale}${cleanPath}` : cleanPath || '/';
            // Ensure no trailing slash for homepage
            if (url === '/') {
              url = '';
            }
          }

          return (
            <li>
              <a
                href={url}
                class:list={[
                  'block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white',
                  { 'font-semibold bg-gray-50 dark:bg-gray-600': locale === currentLocale },
                ]}
                hreflang={locale}
                aria-current={locale === currentLocale ? 'page' : undefined}
              >
                <span class="inline-flex items-center">{getLocaleDisplayName(locale)}</span>
              </a>
            </li>
          );
        })
      }
    </ul>
  </div>
</div>
